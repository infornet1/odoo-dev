<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Template for when a portal user has no linked employee -->
    <template id="portal_my_details_no_employee" name="My Details - No Employee">
        <t t-call="portal.portal_layout">
            <t t-set="no_breadcrumbs" t-value="True"/>
            <div class="alert alert-warning mt-3" role="alert">
                <h4>No Employee Record Found</h4>
                <p>
                    Your user account is not linked to an employee record. Please contact the HR department for assistance.
                </p>
            </div>
        </t>
    </template>

    <!-- Main Template for the Self-Service Page -->
    <template id="portal_my_details" name="My Details">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True"/>

            <t t-call="portal.portal_searchbar">
                <t t-set="title">My Details</t>
            </t>

            <div t-if="success" class="alert alert-success mt-3" role="alert">
                <t t-esc="success"/>
            </div>
            <div t-if="error" class="alert alert-danger mt-3" role="alert">
                <t t-esc="error"/>
            </div>
            
            <ul class="nav nav-tabs mt-3" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="details-tab" data-bs-toggle="tab" href="#details" role="tab" aria-controls="details" aria-selected="true">Personal Details</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="payslips-tab" data-bs-toggle="tab" href="#payslips" role="tab" aria-controls="payslips" aria-selected="false">My Payslips</a>
                </li>
            </ul>

            <div class="tab-content" id="myDetailsTabContent">
                <!-- Personal Details Tab -->
                <div class="tab-pane fade show active" id="details" role="tabpanel" aria-labelledby="details-tab">
                    <div class="card mt-3">
                        <div class="card-header">
                            <h5>Contact &amp; Personal Information</h5>
                        </div>
                        <div class="card-body">
                            <form action="/my/details" method="post">
                                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label" for="private_phone">Home Phone</label>
                                            <input type="text" class="form-control" name="private_phone" t-att-value="employee.private_phone"/>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label" for="vat">VAT / Tax ID</label>
                                            <input type="text" class="form-control" name="vat" t-att-value="employee.vat"/>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label" for="marital">Marital Status</label>
                                            <select name="marital" class="form-select">
                                                <option value="single" t-att-selected="employee.marital == 'single'">Single</option>
                                                <option value="married" t-att-selected="employee.marital == 'married'">Married</option>
                                                <option value="cohabitant" t-att-selected="employee.marital == 'cohabitant'">Legal Cohabitant</option>
                                                <option value="widower" t-att-selected="employee.marital == 'widower'">Widower</option>
                                                <option value="divorced" t-att-selected="employee.marital == 'divorced'">Divorced</option>
                                            </select>
                                        </div>
                                         <div class="mb-3">
                                            <label class="form-label" for="private_street">Home Address</label>
                                            <textarea class="form-control" name="private_street" rows="3"><t t-esc="employee.private_street"/></textarea>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <button type="submit" class="btn btn-primary">Save Changes</button>
                                </div>
                            </form>
                        </div>
                        <div class="card-footer text-muted">
                            <h5 class="mt-2">Contract Information (Read-Only)</h5>
                            <p><strong>Job Title:</strong> <t t-esc="employee.job_title"/></p>
                            <p><strong>Contract Start Date:</strong> <t t-esc="employee.contract_id.date_start"/></p>
                            <!-- Add other ueipab fields here as needed -->
                        </div>
                    </div>
                </div>

                <!-- Payslips Tab -->
                <div class="tab-pane fade" id="payslips" role="tabpanel" aria-labelledby="payslips-tab">
                    <div t-if="not payslips" class="alert alert-info mt-3" role="alert">
                        You have no payslips available.
                    </div>
                    <t t-if="payslips">
                        <div class="table-responsive mt-3">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Reference</th>
                                        <th>From</th>
                                        <th>To</th>
                                        <th class="text-end">Net Salary</th>
                                        <th/>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr t-foreach="payslips" t-as="slip">
                                        <td><t t-esc="slip.number"/></td>
                                        <td><span t-field="slip.date_from"/></td>
                                        <td><span t-field="slip.date_to"/></td>
                                        <td class="text-end">
                                            <t t-if="slip.company_id.currency_id">
                                                <span t-esc="slip.line_ids.filtered(lambda line: line.code == 'NET').total"
                                                      t-options="{'widget': 'monetary', 'display_currency': slip.company_id.currency_id}"/>
                                            </t>
                                            <t t-else="">
                                                <span t-esc="slip.line_ids.filtered(lambda line: line.code == 'NET').total"/>
                                            </t>
                                        </td>
                                        <td class="text-end">
                                            <a class="btn btn-sm btn-primary" t-attf-href="/my/payslip/print?payslip_id=#{slip.id}" title="Download">
                                                <i class="fa fa-download"/> Download
                                            </a>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div t-if="pager" class="o_portal_pager text-center">
                            <t t-call="portal.pager"/>
                        </div>
                    </t>
                </div>
            </div>
        </t>
    </template>

    <!-- Add link to Portal Home (My Account) -->
    <template id="portal_my_home_add_details_link" inherit_id="portal.portal_my_home">
        <xpath expr="//div[hasclass('o_portal_docs')]" position="inside">
            <li class="list-group-item">
                <a href="/my/details">
                    <i class="fa fa-fw fa-id-card-o"/> My Details &amp; Payslips
                </a>
            </li>
        </xpath>
    </template>
</odoo>
