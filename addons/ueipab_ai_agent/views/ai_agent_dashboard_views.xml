<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Dashboard Form View -->
    <record id="ai_agent_dashboard_view_form" model="ir.ui.view">
        <field name="name">ai.agent.dashboard.form</field>
        <field name="model">ai.agent.dashboard</field>
        <field name="arch" type="xml">
            <form string="Panel de Control" create="false" delete="false">
                <header>
                    <button name="action_apply" string="Aplicar"
                            type="object" class="btn-primary"
                            icon="fa-check"/>
                    <button name="action_check_credits" string="Verificar Creditos"
                            type="object" class="btn-secondary"
                            icon="fa-refresh"/>
                    <button name="action_refresh" string="Actualizar"
                            type="object" class="btn-secondary"
                            icon="fa-sync"/>
                </header>
                <sheet>
                    <!-- Alert banners -->
                    <div class="alert alert-warning text-center" role="alert"
                         invisible="not dry_run">
                        <strong>MODO PRUEBA:</strong> Las llamadas a WhatsApp y Claude estan desactivadas.
                    </div>
                    <div class="alert alert-success text-center" role="alert"
                         invisible="dry_run">
                        <strong>MODO PRODUCCION:</strong> El agente esta activo y procesando mensajes.
                    </div>
                    <div class="alert alert-danger text-center" role="alert"
                         invisible="credits_ok == 'ok'">
                        <strong>CREDITOS AGOTADOS:</strong> Kill switch activado â€” todas las llamadas salientes estan bloqueadas.
                    </div>

                    <!-- Estado General (always visible above tabs) -->
                    <group string="Estado General">
                        <group>
                            <field name="dry_run" widget="boolean_toggle"/>
                            <field name="active_db"/>
                        </group>
                        <group>
                            <field name="credits_ok" widget="badge"
                                   decoration-success="credits_ok == 'ok'"
                                   decoration-danger="credits_ok == 'error'"/>
                        </group>
                    </group>

                    <!-- Tabbed sections -->
                    <notebook>

                        <!-- Tab 1: Tareas Programadas -->
                        <page string="Tareas Programadas" name="page_crons">
                            <group string="Crons de Odoo (controlables)">
                                <group string="Poll WhatsApp">
                                    <field name="cron_poll_active" widget="boolean_toggle"
                                           string="Activo"/>
                                    <field name="cron_poll_interval" string="Frecuencia"/>
                                    <field name="cron_poll_nextcall" string="Proxima"/>
                                    <field name="cron_poll_lastcall" string="Ultima"/>
                                </group>
                                <group string="Timeouts y Recordatorios">
                                    <field name="cron_timeout_active" widget="boolean_toggle"
                                           string="Activo"/>
                                    <field name="cron_timeout_interval" string="Frecuencia"/>
                                    <field name="cron_timeout_nextcall" string="Proxima"/>
                                    <field name="cron_timeout_lastcall" string="Ultima"/>
                                </group>
                                <group string="Credit Guard">
                                    <field name="cron_credits_active" widget="boolean_toggle"
                                           string="Activo"/>
                                    <field name="cron_credits_interval" string="Frecuencia"/>
                                    <field name="cron_credits_nextcall" string="Proxima"/>
                                    <field name="cron_credits_lastcall" string="Ultima"/>
                                </group>
                            </group>
                            <group string="Crons del Sistema (solo lectura)">
                                <group>
                                    <field name="sys_cron_escalation_info"
                                           string="Escalation Bridge"/>
                                    <field name="sys_cron_resolution_info"
                                           string="Resolution Bridge"/>
                                    <field name="sys_cron_email_checker_info"
                                           string="Email Checker"/>
                                </group>
                                <group>
                                    <field name="sys_cron_wa_health_info"
                                           string="WA Health Monitor"/>
                                    <field name="sys_cron_bounce_processor_info"
                                           string="Bounce Processor"/>
                                    <field name="sys_cron_customer_matching_info"
                                           string="Akdemia Pipeline"/>
                                </group>
                            </group>
                            <div class="alert alert-info mt-2" role="alert">
                                <i class="fa fa-info-circle"/> Los crons del sistema se ejecutan fuera de Odoo
                                (<code>/etc/cron.d/</code>). Para activar/desactivar, editar los archivos del servidor.
                            </div>
                        </page>

                        <!-- Tab 2: Creditos y Consumo -->
                        <page string="Creditos y Consumo" name="page_credits">
                            <group>
                                <group string="WhatsApp (MassivaMovil)">
                                    <field name="wa_remaining_sends"/>
                                    <field name="wa_total_sends"/>
                                    <field name="wa_sends_threshold"/>
                                </group>
                                <group string="Claude AI (Anthropic)">
                                    <field name="claude_total_spend"/>
                                    <field name="claude_spend_limit_usd"/>
                                    <field name="claude_total_input_tokens"/>
                                    <field name="claude_total_output_tokens"/>
                                    <field name="claude_input_rate"/>
                                    <field name="claude_output_rate"/>
                                </group>
                            </group>
                        </page>

                        <!-- Tab 3: Cuenta WhatsApp -->
                        <page string="Cuenta WhatsApp" name="page_whatsapp">
                            <group>
                                <group>
                                    <field name="whatsapp_active_account" widget="badge"
                                           decoration-success="whatsapp_active_account == 'primary'"
                                           decoration-warning="whatsapp_active_account == 'backup'"/>
                                    <field name="whatsapp_primary_phone"/>
                                    <field name="whatsapp_backup_phone"/>
                                </group>
                                <group>
                                    <field name="whatsapp_flagged_phone"
                                           invisible="not whatsapp_flagged_phone"/>
                                    <field name="whatsapp_flagged_date"
                                           invisible="not whatsapp_flagged_date"/>
                                    <button name="action_switch_whatsapp_account"
                                            string="Cambiar Cuenta"
                                            type="object" class="btn-warning"
                                            icon="fa-exchange"
                                            confirm="Cambiar la cuenta WhatsApp activa? Esto afecta todos los envios."/>
                                </group>
                            </group>
                        </page>

                        <!-- Tab 4: Pipeline Akdemia -->
                        <page string="Pipeline Akdemia" name="page_pipeline">
                            <group string="Ultimo Scraping de Akdemia">
                                <group>
                                    <field name="akdemia_last_scrape_status" widget="badge"
                                           string="Estado"
                                           decoration-success="akdemia_last_scrape_status == 'ok'"
                                           decoration-danger="akdemia_last_scrape_status == 'error'"/>
                                    <field name="akdemia_last_scrape_date" string="Fecha"/>
                                </group>
                                <group>
                                    <field name="akdemia_last_scrape_file" string="Archivo"/>
                                </group>
                            </group>
                            <group string="Distribucion de Bounce Logs">
                                <group>
                                    <field name="bounce_pending_count" string="Pendiente"/>
                                    <field name="bounce_contacted_count" string="Contactado"/>
                                </group>
                                <group>
                                    <field name="bounce_akdemia_pending_count"
                                           string="Pendiente Akdemia"/>
                                    <field name="bounce_resolved_count" string="Resuelto"/>
                                </group>
                            </group>
                        </page>

                        <!-- Tab 5: Configuracion -->
                        <page string="Configuracion" name="page_config">
                            <group string="Horario de Contacto (VET)">
                                <group string="Lunes a Viernes">
                                    <field name="schedule_weekday_start"/>
                                    <field name="schedule_weekday_end"/>
                                </group>
                                <group string="Sabado y Domingo">
                                    <field name="schedule_weekend_start"/>
                                    <field name="schedule_weekend_end"/>
                                </group>
                            </group>
                            <group string="Identidad del Agente">
                                <group>
                                    <field name="agent_display_name"/>
                                    <field name="institution_display_name"/>
                                </group>
                                <group>
                                    <field name="whatsapp_send_interval"/>
                                </group>
                            </group>
                        </page>

                        <!-- Tab 6: Estadisticas -->
                        <page string="Estadisticas" name="page_stats">
                            <group>
                                <group>
                                    <field name="active_conversations_count"/>
                                    <field name="pending_bounce_count"/>
                                </group>
                                <group>
                                    <field name="total_messages_sent"/>
                                </group>
                            </group>
                        </page>

                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Dashboard Action -->
    <record id="ai_agent_dashboard_action" model="ir.actions.act_window">
        <field name="name">Panel de Control</field>
        <field name="res_model">ai.agent.dashboard</field>
        <field name="view_mode">form</field>
        <field name="target">inline</field>
        <field name="context">{'form_view_initial_mode': 'edit'}</field>
    </record>

</odoo>
