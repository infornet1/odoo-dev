<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- ========================================
         Payslip State Control
         Maintain batch-payslip state integrity
         ======================================== -->

    <!-- Extend payslip form to control button visibility based on batch state -->
    <record id="hr_payslip_form_batch_state_control" model="ir.ui.view">
        <field name="name">hr.payslip.form.batch.state.control</field>
        <field name="model">hr.payslip</field>
        <field name="inherit_id" ref="hr_payroll_community.hr_payslip_view_form"/>
        <field name="arch" type="xml">

            <!-- Add payslip_run_state field (hidden, for visibility control) -->
            <field name="state" position="before">
                <field name="payslip_run_state" invisible="1"/>
            </field>

            <!-- Modify "Set to Draft" button visibility to check batch state -->
            <button name="action_payslip_draft" position="attributes">
                <attribute name="invisible">state != 'cancel' or payslip_run_state == 'cancel'</attribute>
            </button>

            <!-- Add warning banner when payslip belongs to cancelled batch -->
            <header position="inside">
                <button name="action_compose_payslip_email"
                        string="Send by Email"
                        type="object"
                        class="oe_highlight"
                        icon="fa-envelope"
                        help="Compose and send payslip by email"/>
                <div class="alert alert-warning mb-0"
                     role="alert"
                     invisible="payslip_run_state != 'cancel'">
                    <strong>Cancelled Batch:</strong> This payslip belongs to a cancelled batch and cannot be modified.
                    To reopen, first set the batch to draft.
                </div>
            </header>

            <!-- Add Acknowledgment section after other info -->
            <notebook position="inside">
                <page string="ðŸ“ Acknowledgment" name="acknowledgment">
                    <group>
                        <group string="Acknowledgment Status">
                            <field name="is_acknowledged" widget="boolean_toggle"/>
                            <field name="acknowledged_date" readonly="1"/>
                            <button name="action_reset_acknowledgment"
                                    string="Reset Acknowledgment"
                                    type="object"
                                    class="btn-secondary"
                                    icon="fa-undo"
                                    invisible="not is_acknowledged"
                                    confirm="Are you sure you want to reset the acknowledgment status?"/>
                        </group>
                        <group string="Audit Information">
                            <field name="acknowledged_ip" readonly="1"/>
                            <field name="acknowledged_user_agent" readonly="1"/>
                            <field name="access_token" readonly="1" groups="base.group_system"/>
                        </group>
                    </group>
                </page>
            </notebook>

        </field>
    </record>

    <!-- Extend payslip tree view to show acknowledgment status -->
    <record id="hr_payslip_tree_acknowledgment" model="ir.ui.view">
        <field name="name">hr.payslip.tree.acknowledgment</field>
        <field name="model">hr.payslip</field>
        <field name="inherit_id" ref="hr_payroll_community.hr_payslip_view_tree"/>
        <field name="arch" type="xml">
            <field name="state" position="before">
                <field name="is_acknowledged" string="Ack" widget="boolean_toggle" optional="show"/>
            </field>
        </field>
    </record>

</odoo>
