<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- ========================================
         Enhancement 1: Total Net Balance Field
         ======================================== -->

    <!-- Extend tree view to add Total Net Payable column -->
    <record id="hr_payslip_run_tree_total_net" model="ir.ui.view">
        <field name="name">hr.payslip.run.tree.total.net</field>
        <field name="model">hr.payslip.run</field>
        <field name="inherit_id" ref="hr_payroll_community.hr_payslip_run_view_tree"/>
        <field name="arch" type="xml">
            <!-- Add Total Net Payable column after Credit Note field -->
            <field name="credit_note" position="after">
                <field name="total_net_amount"
                       string="Total Net Payable"
                       sum="Total Net Payable"
                       widget="monetary"
                       options="{'currency_field': 'currency_id'}"/>
            </field>
        </field>
    </record>

    <!-- Extend form view to add Total Net Payable and Exchange Rate fields -->
    <record id="hr_payslip_run_form_total_net" model="ir.ui.view">
        <field name="name">hr.payslip.run.form.total.net</field>
        <field name="model">hr.payslip.run</field>
        <field name="inherit_id" ref="hr_payroll_community.hr_payslip_run_view_form"/>
        <field name="arch" type="xml">
            <!-- Add Total Net Payable field in header area, after Credit Note -->
            <field name="credit_note" position="after">
                <field name="total_net_amount"
                       widget="monetary"
                       options="{'currency_field': 'currency_id'}"/>
                <field name="currency_id" invisible="1"/>
                <field name="exchange_rate"
                       widget="float"
                       options="{'digits': [12, 6]}"/>
                <button name="action_apply_exchange_rate"
                        type="object"
                        string="Apply Rate to Payslips"
                        class="oe_link"
                        icon="fa-refresh"
                        help="Apply this exchange rate to all payslips in the batch"
                        invisible="not exchange_rate or not slip_ids"/>
                <button name="action_sync_dates_to_payslips"
                        type="object"
                        string="Sync Dates to Payslips"
                        class="oe_link"
                        icon="fa-calendar"
                        help="Update all draft payslips with the batch date range"
                        invisible="not slip_ids"/>
            </field>
        </field>
    </record>

    <!-- ========================================
         Enhancement 2: Print Disbursement Report
         ======================================== -->

    <!-- Add Print Disbursement List button and Send Email button to form view -->
    <record id="hr_payslip_run_form_print_button" model="ir.ui.view">
        <field name="name">hr.payslip.run.form.print.button</field>
        <field name="model">hr.payslip.run</field>
        <field name="inherit_id" ref="hr_payroll_community.hr_payslip_run_view_form"/>
        <field name="arch" type="xml">
            <!-- Add Print button in header, before Close button -->
            <button name="close_payslip_run" position="before">
                <button name="%(ueipab_payroll_enhancements.action_report_disbursement_list)d"
                        type="action"
                        string="Print Disbursement List"
                        class="btn-primary"
                        icon="fa-print"
                        help="Generate ICF-compliant disbursement list report for finance approval"/>

                <!-- Email Actions - Compact button group -->
                <div class="btn-group" invisible="not slip_ids">
                    <button name="action_send_batch_emails"
                            type="object"
                            class="btn btn-secondary btn-sm"
                            icon="fa-envelope"
                            title="Send Payslips by Email (no progress)"/>
                    <button name="%(ueipab_payroll_enhancements.action_batch_email_wizard)d"
                            type="action"
                            class="btn btn-secondary btn-sm"
                            icon="fa-paper-plane"
                            title="Send Emails (with Progress)"/>
                    <button name="%(ueipab_payroll_enhancements.action_ack_reminder_wizard)d"
                            type="action"
                            class="btn btn-secondary btn-sm"
                            icon="fa-bell"
                            title="Send Ack Reminders"/>
                </div>
            </button>
            <!-- Add email template selector field after exchange rate -->
            <field name="exchange_rate" position="after">
                <field name="email_template_id"
                       placeholder="Select email template..."
                       help="Choose which email template to use when sending payslips"/>
            </field>
        </field>
    </record>

    <!-- ========================================
         Enhancement 3: Cancel Workflow
         ======================================== -->

    <!-- Add Cancel and Set to Draft buttons to form view -->
    <record id="hr_payslip_run_form_cancel_buttons" model="ir.ui.view">
        <field name="name">hr.payslip.run.form.cancel.buttons</field>
        <field name="model">hr.payslip.run</field>
        <field name="inherit_id" ref="hr_payroll_community.hr_payslip_run_view_form"/>
        <field name="arch" type="xml">
            <!-- Add Cancel button after Set to Draft button -->
            <button name="action_payslip_run" position="after">
                <button name="action_cancel"
                        type="object"
                        string="Cancel"
                        class="btn-warning"
                        icon="fa-ban"
                        invisible="state == 'cancel'"
                        confirm="Are you sure you want to cancel this batch? All associated payslips will also be cancelled."
                        help="Cancel this batch and all payslips (preserves audit trail)"/>
                <button name="action_draft"
                        type="object"
                        string="Set to Draft"
                        invisible="state != 'cancel'"
                        help="Reopen cancelled batch"/>
            </button>
        </field>
    </record>

    <!-- Add visual indicator for cancelled state in tree view -->
    <record id="hr_payslip_run_tree_cancel_decoration" model="ir.ui.view">
        <field name="name">hr.payslip.run.tree.cancel.decoration</field>
        <field name="model">hr.payslip.run</field>
        <field name="inherit_id" ref="hr_payroll_community.hr_payslip_run_view_tree"/>
        <field name="arch" type="xml">
            <!-- Add text decoration for cancelled records -->
            <tree position="attributes">
                <attribute name="decoration-muted">state == 'cancel'</attribute>
            </tree>
        </field>
    </record>

    <!-- ========================================
         Enhancement 4: Advance Payment Fields
         ======================================== -->

    <!-- Add Advance Payment section to form view -->
    <record id="hr_payslip_run_form_advance_payment" model="ir.ui.view">
        <field name="name">hr.payslip.run.form.advance.payment</field>
        <field name="model">hr.payslip.run</field>
        <field name="inherit_id" ref="hr_payroll_community.hr_payslip_run_view_form"/>
        <field name="priority">50</field>
        <field name="arch" type="xml">
            <!-- Add advance payment fields after email_template_id -->
            <field name="email_template_id" position="after">
                <field name="is_advance_payment"/>
                <field name="advance_percentage"
                       invisible="not is_advance_payment"
                       widget="float"
                       options="{'digits': [5, 2]}"/>
                <field name="advance_total_amount"
                       invisible="not is_advance_payment"
                       widget="monetary"
                       options="{'currency_field': 'currency_id'}"
                       class="fw-bold text-primary"/>
            </field>
        </field>
    </record>

    <!-- Add Advance Total to tree view when advance payment is active -->
    <record id="hr_payslip_run_tree_advance_amount" model="ir.ui.view">
        <field name="name">hr.payslip.run.tree.advance.amount</field>
        <field name="model">hr.payslip.run</field>
        <field name="inherit_id" ref="hr_payroll_community.hr_payslip_run_view_tree"/>
        <field name="arch" type="xml">
            <field name="total_net_amount" position="after">
                <field name="is_advance_payment" column_invisible="1"/>
                <field name="advance_percentage"
                       string="% Adelanto"
                       optional="hide"/>
                <field name="advance_total_amount"
                       string="Total Adelanto"
                       sum="Total Adelanto"
                       widget="monetary"
                       options="{'currency_field': 'currency_id'}"
                       optional="hide"/>
            </field>
        </field>
    </record>


</odoo>
