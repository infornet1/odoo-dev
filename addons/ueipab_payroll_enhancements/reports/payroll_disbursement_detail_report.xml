<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- ========================================
         Payroll Disbursement Detail Report
         Landscape, Letter Size, Courier New Font
         ======================================== -->

    <!-- Custom Paper Format: Landscape Letter -->
    <record id="paperformat_payroll_disbursement_detail" model="report.paperformat">
        <field name="name">Payroll Disbursement Detail Format</field>
        <field name="default" eval="False"/>
        <field name="format">Letter</field>
        <field name="page_height">0</field>
        <field name="page_width">0</field>
        <field name="orientation">Landscape</field>
        <field name="margin_top">40</field>
        <field name="margin_bottom">25</field>
        <field name="margin_left">7</field>
        <field name="margin_right">7</field>
        <field name="header_line" eval="False"/>
        <field name="header_spacing">35</field>
        <field name="dpi">90</field>
    </record>

    <!-- Report Template -->
    <template id="disbursement_detail_doc">
        <t t-call="web.html_container">
            <t t-call="web.external_layout">
                <div class="page" style="font-family: 'Courier New', monospace; font-size: 9pt;">
                    <!-- Calculate actual period from payslips BEFORE using in header -->
                    <t t-set="period_start" t-value="min(docs.mapped('date_from')) if docs else None"/>
                    <t t-set="period_end" t-value="max(docs.mapped('date_to')) if docs else None"/>

                    <!-- Get exchange rate for VEB currency (if applicable) -->
                    <t t-set="exchange_rate_display" t-value="''"/>
                    <t t-if="currency.name == 'VEB' and period_end">
                        <t t-set="rate_record" t-value="request.env['res.currency.rate'].search([('currency_id', '=', currency.id), ('name', '&lt;=', period_end)], limit=1, order='name desc')"/>
                        <t t-if="rate_record">
                            <t t-set="veb_per_usd" t-value="rate_record.company_rate"/>
                            <t t-set="exchange_rate_display" t-value="' @ %.2f VEB/USD' % veb_per_usd"/>
                        </t>
                    </t>

                    <!-- Custom Report Header (appears on every page) -->
                    <div class="row" style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 2px solid #333;">
                        <div class="col-12 text-center">
                            <h3 style="font-family: 'Courier New', monospace; margin-bottom: 5px; margin-top: 0;">
                                <strong>PAYROLL DISBURSEMENT DETAIL REPORT</strong>
                            </h3>
                            <p style="margin: 2px 0; font-size: 8pt;">
                                <t t-if="data and data.get('batch_name')">
                                    Batch: <strong><t t-esc="data.get('batch_name')"/></strong>
                                </t>
                                <t t-if="period_start and period_end">
                                    | Period: <strong>
                                        <t t-esc="period_start"/> - <t t-esc="period_end"/>
                                    </strong>
                                </t>
                                | Currency: <strong><t t-esc="currency.name"/> (<t t-esc="currency.symbol"/>)<t t-esc="exchange_rate_display"/></strong>
                            </p>
                            <p style="margin: 2px 0; font-size: 8pt;">
                                Report Date: <span t-esc="time.strftime('%Y-%m-%d %H:%M')"/>
                            </p>
                        </div>
                    </div>

                    <!-- Initialize totals ONCE for the entire report -->
                    <t t-set="total_salary" t-value="0.0"/>
                    <t t-set="total_bonus" t-value="0.0"/>
                    <t t-set="total_ari" t-value="0.0"/>
                    <t t-set="total_sso" t-value="0.0"/>
                    <t t-set="total_faov" t-value="0.0"/>
                    <t t-set="total_paro" t-value="0.0"/>
                    <t t-set="total_other_deductions" t-value="0.0"/>
                    <t t-set="total_net" t-value="0.0"/>

                    <!-- Payslip Details Table -->
                    <table class="table table-sm table-bordered" style="font-family: 'Courier New', monospace; font-size: 8pt; margin-top: 10px; width: 100%;">
                            <thead style="background-color: #e9ecef;">
                                <tr>
                                    <th style="width: 2%; text-align: center; padding: 3px; font-size: 7pt;">#</th>
                                    <th style="width: 8%; text-align: center; padding: 3px; font-size: 7pt;">VAT ID</th>
                                    <th style="width: 15%; padding: 3px; font-size: 7pt;">Employee</th>
                                    <th style="width: 8%; text-align: right; padding: 3px; font-size: 7pt;">Salary</th>
                                    <th style="width: 8%; text-align: right; padding: 3px; font-size: 7pt;">Bonus</th>
                                    <th style="width: 7%; text-align: right; padding: 3px; font-size: 7pt;">ARI</th>
                                    <th style="width: 7%; text-align: right; padding: 3px; font-size: 7pt;">SSO 4%</th>
                                    <th style="width: 7%; text-align: right; padding: 3px; font-size: 7pt;">FAOV 1%</th>
                                    <th style="width: 7%; text-align: right; padding: 3px; font-size: 7pt;">PARO 0.5%</th>
                                    <th style="width: 9%; text-align: right; padding: 3px; font-size: 7pt;">Other Ded</th>
                                    <th style="width: 11%; text-align: right; padding: 3px; font-size: 7pt;">Net <t t-esc="currency.name"/></th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-set="sequence" t-value="1"/>
                                <t t-foreach="docs" t-as="payslip">
                                    <!-- Calculate amounts for this payslip -->
                                    <t t-set="ari_amount" t-value="0.0"/>
                                    <t t-set="sso_amount" t-value="0.0"/>
                                    <t t-set="faov_amount" t-value="0.0"/>
                                    <t t-set="paro_amount" t-value="0.0"/>
                                    <t t-set="other_deductions_amount" t-value="0.0"/>
                                    <t t-set="net_amount" t-value="0.0"/>

                                    <!-- Calculate SALARY from contract deduction base (base salary for SS/tax calculations) -->
                                    <t t-set="salary_amount" t-value="payslip.contract_id.ueipab_deduction_base or 0.0"/>

                                    <!-- Calculate BONUS from contract (total wage minus deduction base = all bonuses/benefits) -->
                                    <t t-set="bonus_amount" t-value="(payslip.contract_id.wage or 0.0) - (payslip.contract_id.ueipab_deduction_base or 0.0)"/>

                                    <!-- Calculate ARI (income tax withholding) -->
                                    <t t-set="ari_line" t-value="payslip.line_ids.filtered(lambda l: l.salary_rule_id.code == 'VE_ARI_DED')"/>
                                    <t t-if="ari_line">
                                        <t t-set="ari_amount" t-value="abs(ari_line[0].total)"/>
                                    </t>

                                    <!-- Calculate SSO (4%) -->
                                    <t t-set="sso_line" t-value="payslip.line_ids.filtered(lambda l: l.salary_rule_id.code == 'VE_SSO_DED')"/>
                                    <t t-if="sso_line">
                                        <t t-set="sso_amount" t-value="abs(sso_line[0].total)"/>
                                    </t>

                                    <!-- Calculate FAOV (1%) -->
                                    <t t-set="faov_line" t-value="payslip.line_ids.filtered(lambda l: l.salary_rule_id.code == 'VE_FAOV_DED')"/>
                                    <t t-if="faov_line">
                                        <t t-set="faov_amount" t-value="abs(faov_line[0].total)"/>
                                    </t>

                                    <!-- Calculate PARO (0.5%) -->
                                    <t t-set="paro_line" t-value="payslip.line_ids.filtered(lambda l: l.salary_rule_id.code == 'VE_PARO_DED')"/>
                                    <t t-if="paro_line">
                                        <t t-set="paro_amount" t-value="abs(paro_line[0].total)"/>
                                    </t>

                                    <!-- Calculate Other Deductions (everything else negative except ARI and Social Security) -->
                                    <t t-foreach="payslip.line_ids.filtered(lambda l: l.total &lt; 0 and l.salary_rule_id.code not in ('VE_ARI_DED', 'VE_SSO_DED', 'VE_FAOV_DED', 'VE_PARO_DED', 'LIQUID_INCES'))" t-as="line">
                                        <t t-set="other_deductions_amount" t-value="other_deductions_amount + abs(line.total)"/>
                                    </t>

                                    <!-- Get NET amount -->
                                    <t t-set="net_line" t-value="payslip.line_ids.filtered(lambda l: l.salary_rule_id.code == 'VE_NET')"/>
                                    <t t-if="net_line">
                                        <t t-set="net_amount" t-value="net_line[0].total"/>
                                    </t>

                                    <!-- Accumulate totals -->
                                    <t t-set="total_salary" t-value="total_salary + salary_amount"/>
                                    <t t-set="total_bonus" t-value="total_bonus + bonus_amount"/>
                                    <t t-set="total_ari" t-value="total_ari + ari_amount"/>
                                    <t t-set="total_sso" t-value="total_sso + sso_amount"/>
                                    <t t-set="total_faov" t-value="total_faov + faov_amount"/>
                                    <t t-set="total_paro" t-value="total_paro + paro_amount"/>
                                    <t t-set="total_other_deductions" t-value="total_other_deductions + other_deductions_amount"/>
                                    <t t-set="total_net" t-value="total_net + net_amount"/>

                                    <!-- Employee Row (multiply USD values by exchange_rate for display) -->
                                    <tr>
                                        <td style="text-align: center; padding: 2px; font-size: 7pt;"><t t-esc="sequence"/></td>
                                        <td style="text-align: center; padding: 2px; font-size: 7pt;"><t t-esc="payslip.employee_id.identification_id or 'N/A'"/></td>
                                        <td style="padding: 2px; font-size: 7pt;"><t t-esc="payslip.employee_id.name"/></td>
                                        <td style="text-align: right; padding: 2px; font-size: 7pt;"><t t-esc="'{:,.2f}'.format(salary_amount * exchange_rate)"/></td>
                                        <td style="text-align: right; padding: 2px; font-size: 7pt;"><t t-esc="'{:,.2f}'.format(bonus_amount * exchange_rate)"/></td>
                                        <td style="text-align: right; padding: 2px; font-size: 7pt;"><t t-esc="'{:,.2f}'.format(ari_amount * exchange_rate)"/></td>
                                        <td style="text-align: right; padding: 2px; font-size: 7pt;"><t t-esc="'{:,.2f}'.format(sso_amount * exchange_rate)"/></td>
                                        <td style="text-align: right; padding: 2px; font-size: 7pt;"><t t-esc="'{:,.2f}'.format(faov_amount * exchange_rate)"/></td>
                                        <td style="text-align: right; padding: 2px; font-size: 7pt;"><t t-esc="'{:,.2f}'.format(paro_amount * exchange_rate)"/></td>
                                        <td style="text-align: right; padding: 2px; font-size: 7pt;"><t t-esc="'{:,.2f}'.format(other_deductions_amount * exchange_rate)"/></td>
                                        <td style="text-align: right; padding: 2px; font-size: 7pt;"><strong><t t-esc="'{:,.2f}'.format(net_amount * exchange_rate)"/></strong></td>
                                    </tr>

                                    <t t-set="sequence" t-value="sequence + 1"/>
                                </t>
                            </tbody>
                    </table>

                    <!-- Calculate 9% Tax on Net Payable -->
                    <t t-set="tax_9_percent" t-value="total_net * 0.09"/>

                    <!-- Summary Section with Totals -->
                    <div class="row mt-3" style="font-size: 9pt; border-top: 2px solid #333; padding-top: 10px;">
                        <div class="col-6">
                            <p style="margin: 3px 0;">
                                <strong>Employees:</strong>
                                <t t-esc="data.get('employee_count', len(docs.mapped('employee_id'))) if data else len(docs.mapped('employee_id'))"/>
                            </p>
                            <p style="margin: 3px 0;">
                                <strong>Payslips:</strong>
                                <t t-esc="data.get('payslip_count', len(docs)) if data else len(docs)"/>
                            </p>
                            <p style="margin: 3px 0;">
                                <strong>Total Salary:</strong> <t t-esc="currency.symbol"/> <t t-esc="'{:,.2f}'.format(total_salary * exchange_rate)"/>
                            </p>
                            <p style="margin: 3px 0;">
                                <strong>Total Bonus:</strong> <t t-esc="currency.symbol"/> <t t-esc="'{:,.2f}'.format(total_bonus * exchange_rate)"/>
                            </p>
                            <p style="margin: 3px 0;">
                                <strong>Total Deductions:</strong> <t t-esc="currency.symbol"/> <t t-esc="'{:,.2f}'.format((total_ari + total_sso + total_faov + total_paro + total_other_deductions) * exchange_rate)"/>
                            </p>
                        </div>
                        <div class="col-6 text-end">
                            <p style="margin: 3px 0; font-size: 10pt;">
                                <strong>Total Net Payable (<t t-esc="currency.name"/>):</strong> <span style="font-size: 11pt; color: #0066cc;"><t t-esc="currency.symbol"/> <t t-esc="'{:,.2f}'.format(total_net * exchange_rate)"/></span>
                            </p>
                            <p style="margin: 8px 0 3px 0; padding-top: 5px; border-top: 1px solid #ccc;">
                                <strong>9% Tax Payable (<t t-esc="currency.name"/>):</strong> <span style="color: #cc6600;"><t t-esc="currency.symbol"/> <t t-esc="'{:,.2f}'.format(tax_9_percent * exchange_rate)"/></span>
                            </p>
                        </div>
                    </div>

                    <!-- Footer Note -->
                    <div class="row mt-3" style="font-size: 7pt; color: #666;">
                        <div class="col-12">
                            <p style="margin: 0;">
                                <strong>Notes:</strong>
                                This report shows only confirmed payslips (Done/Paid status).
                                Salary = Contract deduction base (base salary for social security/tax calculations).
                                Bonus = Total wage minus deduction base (all bonuses, benefits, cesta ticket, etc.).
                                ARI = Income tax withholding (SENIAT).
                                SSO = Seguro Social Obligatorio (4%).
                                FAOV = Fondo de Ahorro Obligatorio para la Vivienda (1%).
                                PARO = Paro Forzoso (0.5%).
                                Other Ded. = All other deductions not listed above.
                                Currency conversion: All payslip data remains in USD in database. When displaying in VEB, USD amounts are multiplied by exchange rate at report generation time only (no database modification).
                            </p>
                        </div>
                    </div>
                </div><!-- close page -->
            </t><!-- close external_layout -->
        </t><!-- close html_container -->
    </template>

    <!-- Report Action -->
    <record id="action_report_payroll_disbursement_detail" model="ir.actions.report">
        <field name="name">Payroll Disbursement Detail</field>
        <field name="model">hr.payslip</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">ueipab_payroll_enhancements.disbursement_detail_doc</field>
        <field name="report_file">ueipab_payroll_enhancements.disbursement_detail_doc</field>
        <field name="print_report_name">'Payroll Disbursement Detail'</field>
        <field name="paperformat_id" ref="paperformat_payroll_disbursement_detail"/>
    </record>

</odoo>
